From a7f99a0f168385f21fcf6442c7ecdac6826ac23b Mon Sep 17 00:00:00 2001
From: Paul Lesniewski <paul@squirrelmail.org>
Date: Wed, 14 Sep 2016 01:43:49 +0000
Subject: [PATCH 46/50] Fix anomalous crashes recycling used connections
 (thanks to Emmanuel Dreyfus)

git-svn-id: https://svn.code.sf.net/p/squirrelmail/code/trunk/imap_proxy@14569 7612ce4b-ef26-0410-bec9-ea0150e637f0
---
 ChangeLog |  2 ++
 src/icc.c | 23 +++++++++++++++--------
 2 files changed, 17 insertions(+), 8 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index 22ce5e8..f7b8b80 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -3,6 +3,8 @@
 	* Added support for accepting pre-auth ID commands (RFC 2971)
 	* Make EGD support conditional, provide compatibility with
 	  LibreSSL, other small fixes provided by the BSD team
+	* Fixed anomalous crashes recycling used connections (thanks
+	  to Emmanuel Dreyfus)
 
 2014-01-20  Paul Lesniewski <paul@squirrelmail.org>
 	* Added support for up to TLS v1.2 (thanks to Emmanuel Dreyfus)
diff --git a/src/icc.c b/src/icc.c
index 9da7453..c6c7815 100644
--- a/src/icc.c
+++ b/src/icc.c
@@ -136,18 +136,25 @@ static void _ICC_Recycle( unsigned int Expiration )
 		syslog(LOG_INFO, "Expiring server sd [%d]", HashEntry->server_conn->sd);
 		/* Logout of the IMAP server and close the server socket. */
 
-		IMAP_Write( HashEntry->server_conn, "VIC20 LOGOUT\r\n",
-			    strlen( "VIC20 LOGOUT\r\n" ) );
+		if (HashEntry->server_conn->sd != -1)
+		{
+		    IMAP_Write( HashEntry->server_conn, "VIC20 LOGOUT\r\n",
+		    	        strlen( "VIC20 LOGOUT\r\n" ) );
 
 #if HAVE_LIBSSL
-		if ( HashEntry->server_conn->tls )
+		    if ( HashEntry->server_conn->tls )
+		    {
+		        SSL_shutdown( HashEntry->server_conn->tls );
+		        SSL_free( HashEntry->server_conn->tls );
+		    }
+#endif
+		    close( HashEntry->server_conn->sd );
+		    free( HashEntry->server_conn );
+		}
+		else
 		{
-		    SSL_shutdown( HashEntry->server_conn->tls );
-		    SSL_free( HashEntry->server_conn->tls );
+		    syslog(LOG_WARNING, "Expiring freed ICC");
 		}
-#endif
-		close( HashEntry->server_conn->sd );
-		free( HashEntry->server_conn );
 		
 		/*
 		 * This was being counted as a "retained" connection.  It was
-- 
2.7.4

