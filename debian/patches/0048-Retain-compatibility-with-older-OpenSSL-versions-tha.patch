From 57570a2fcf1c088191d39c27d32a96d3e00ed5b1 Mon Sep 17 00:00:00 2001
From: Paul Lesniewski <paul@squirrelmail.org>
Date: Wed, 14 Sep 2016 02:16:55 +0000
Subject: [PATCH 48/50] Retain compatibility with older OpenSSL versions
 (thanks to Wolfgang Breyha)

git-svn-id: https://svn.code.sf.net/p/squirrelmail/code/trunk/imap_proxy@14571 7612ce4b-ef26-0410-bec9-ea0150e637f0
---
 ChangeLog  | 2 ++
 src/icc.c  | 4 +++-
 src/main.c | 6 ++++++
 3 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/ChangeLog b/ChangeLog
index aedf1c0..6435853 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,6 +1,8 @@
 2016-09-12  Paul Lesniewski <paul@squirrelmail.org>
 	* Added support for systemd startup
 	* Added support for accepting pre-auth ID commands (RFC 2971)
+	* Retain compatibility with older OpenSSL versions (thanks to
+	  Wolfgang Breyha)
 	* Make EGD support conditional, provide compatibility with
 	  LibreSSL, other small fixes provided by the BSD team
 	* Fixed anomalous crashes recycling used connections (thanks
diff --git a/src/icc.c b/src/icc.c
index c6c7815..4e65224 100644
--- a/src/icc.c
+++ b/src/icc.c
@@ -153,7 +153,7 @@ static void _ICC_Recycle( unsigned int Expiration )
 		}
 		else
 		{
-		    syslog(LOG_WARNING, "Expiring freed ICC");
+		    syslog(LOG_INFO, "Expiring invalidated server sd");
 		}
 		
 		/*
@@ -281,6 +281,8 @@ void _ICC_Invalidate ( ICC_Struct *ICC )
 
     close( ICC->server_conn->sd );
 
+    syslog(LOG_INFO, "Invalidating server sd [%d]", ICC->server_conn->sd);
+
     ICC->server_conn->sd = -1; /* make sure this can't be reused */
     ICC->logouttime = 1;
 }
diff --git a/src/main.c b/src/main.c
index 4e17bf9..944f5ce 100644
--- a/src/main.c
+++ b/src/main.c
@@ -481,11 +481,15 @@ int main( int argc, char *argv[] )
     if ( PC_Struct.tls_no_tlsv1 ) 
         tls_options |= SSL_OP_NO_TLSv1;
 
+#ifdef SSL_OP_NO_TLSv1_1
     if ( PC_Struct.tls_no_tlsv1_1 ) 
         tls_options |= SSL_OP_NO_TLSv1_1;
+#endif
 
+#ifdef SSL_OP_NO_TLSv1_2
     if ( PC_Struct.tls_no_tlsv1_2 ) 
         tls_options |= SSL_OP_NO_TLSv1_2;
+#endif
 
     SSL_CTX_set_options( tls_ctx, tls_options );
  
@@ -524,6 +528,7 @@ int main( int argc, char *argv[] )
     }
 
     /* Enable ECDHE is OpenSSL has it */
+#if !defined(OPENSSL_NO_ECDH) && OPENSSL_VERSION_NUMBER >= 0x10000000L
 #ifdef NID_X9_62_prime256v1
     {
         EC_KEY *ecdh;
@@ -533,6 +538,7 @@ int main( int argc, char *argv[] )
         EC_KEY_free( ecdh );
     }
 #endif
+#endif
 #endif /* HAVE_LIBSSL */
 
 
-- 
2.7.4

