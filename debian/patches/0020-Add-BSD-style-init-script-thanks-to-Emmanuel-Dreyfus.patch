From 96e6ff966acdeef98608880fcd5160d0baac1c1f Mon Sep 17 00:00:00 2001
From: Paul Lesniewski <paul@squirrelmail.org>
Date: Mon, 18 Apr 2011 00:12:23 +0000
Subject: [PATCH 20/50] Add BSD-style init script (thanks to Emmanuel Dreyfus)

git-svn-id: https://svn.code.sf.net/p/squirrelmail/code/trunk/imap_proxy@14101 7612ce4b-ef26-0410-bec9-ea0150e637f0
---
 ChangeLog                    |   4 ++
 Makefile.in                  |   6 +--
 prototype                    |   2 +-
 scripts/imapproxy-bsd.init   |  47 ++++++++++++++++++++
 scripts/imapproxy-linux.init | 101 +++++++++++++++++++++++++++++++++++++++++++
 scripts/imapproxy.init       | 101 -------------------------------------------
 6 files changed, 156 insertions(+), 105 deletions(-)
 create mode 100644 scripts/imapproxy-bsd.init
 create mode 100755 scripts/imapproxy-linux.init
 delete mode 100755 scripts/imapproxy.init

diff --git a/ChangeLog b/ChangeLog
index e9ad8c3..9be3588 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,4 +1,8 @@
 2011-04-17  Paul Lesniewski <paul@squirrelmail.org>
+        * Add restart operation to (linux) init script
+        * Add BSD-style init script (thanks to Emmanuel Dreyfus)
+
+2011-04-17  Paul Lesniewski <paul@squirrelmail.org>
         * Fixed server connection synchronization issues in the SELECT
           cache code (ensure server failures result in server connections
           being fully shut down and removed from connection cache).
diff --git a/Makefile.in b/Makefile.in
index 4b86e63..0d42ac8 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -83,8 +83,8 @@ install: $(XYD_BIN) $(TAT_BIN)
 	$(INSTALL) -o bin -g bin -m 0755 $(XYD_BIN) $(EBIN)
 	$(INSTALL) -o bin -g bin -m 0755 $(TAT_BIN) $(EBIN)
 
-install-init:
-	$(INSTALL) -o root -g sys -m 0755 ./scripts/imapproxy.init $(ETC)/init.d/imapproxy
+install-init-linux:
+	$(INSTALL) -o root -g sys -m 0755 ./scripts/imapproxy-linux.init $(ETC)/init.d/imapproxy
 	ln -s ../init.d/imapproxy /etc/rc2.d/S99imapproxy
 	ln -s ../init.d/imapproxy /etc/rc0.d/K10imapproxy
 
@@ -93,7 +93,7 @@ install-conf:
 
 rpm-install: install 
 	$(INSTALL) -o root -g sys -m 0644 ./scripts/imapproxy.conf $(rpm_prefix)/etc
-	$(INSTALL) -o root -g sys -m 0755 ./scripts/imapproxy.init $(rpm_prefix)/etc/init.d/imapproxy
+	$(INSTALL) -o root -g sys -m 0755 ./scripts/imapproxy-linux.init $(rpm_prefix)/etc/init.d/imapproxy
 
 pkg:
 	pkgmk -o -r .
diff --git a/prototype b/prototype
index 6feab39..650590c 100644
--- a/prototype
+++ b/prototype
@@ -1,7 +1,7 @@
 i pkginfo
 i copyright
 v none /etc/imapproxy.conf=scripts/imapproxy.conf 0644 root sys
-f none /etc/init.d/imapproxy=scripts/imapproxy.init 0744 root sys
+f none /etc/init.d/imapproxy=scripts/imapproxy-linux.init 0744 root sys
 l none /etc/rc0.d/K10imapproxy=/etc/init.d/imapproxy
 l none /etc/rc1.d/K10imapproxy=/etc/init.d/imapproxy
 l none /etc/rc2.d/K10imapproxy=/etc/init.d/imapproxy
diff --git a/scripts/imapproxy-bsd.init b/scripts/imapproxy-bsd.init
new file mode 100644
index 0000000..a63eab9
--- /dev/null
+++ b/scripts/imapproxy-bsd.init
@@ -0,0 +1,47 @@
+#!/bin/sh
+##
+## Copyright (c) 2010-2011 The SquirrelMail Project Team
+##
+## Licensed under the GNU GPL. For full terms see the file COPYING.
+##
+## This file is part of SquirrelMail IMAP Proxy.
+##
+##  Facility:
+##
+##      imapproxy.init
+##
+##  Abstract:
+##
+##      in.imapproxyd startup script
+##
+##  Authors:
+##
+##      Emmanuel Dreyfus <manu@netbsd.org>
+##
+##  Version:
+##
+##      $Id:$
+##
+##  Modification History:
+##
+##      $Log$
+##
+##
+# BSD-stype init file for squirrelmail-imap_proxy server daemon
+#
+
+# PROVIDE: imapproxy
+# REQUIRE: DAEMON
+# BEFORE:  LOGIN
+
+$_rc_subr_loaded . /etc/rc.subr
+
+name="imapproxy"
+rcvar=$name
+command="@PREFIX@/sbin/in.imapproxyd"
+required_files="@PKG_SYSCONFDIR@/imapproxy.conf"
+
+load_rc_config $name
+run_rc_command "$1"
+
+
diff --git a/scripts/imapproxy-linux.init b/scripts/imapproxy-linux.init
new file mode 100755
index 0000000..5fc94bf
--- /dev/null
+++ b/scripts/imapproxy-linux.init
@@ -0,0 +1,101 @@
+#!/bin/sh
+##
+## Copyright (c) 2010-2011 The SquirrelMail Project Team
+## Copyright (c) 2002-2010 Dave McMurtrie
+##
+## Licensed under the GNU GPL. For full terms see the file COPYING.
+##
+## This file is part of SquirrelMail IMAP Proxy.
+##
+##  Facility:
+##
+##	imapproxy.init
+##
+##  Abstract:
+##
+##	in.imapproxyd startup script
+##
+##  Authors:
+##
+##      Dave McMurtrie <davemcmurtrie@hotmail.com>
+##
+##  Version:
+##
+##      $Id$
+##
+##  Modification History:
+##
+##      $Log$
+##
+##      Revision 1.2  2002/12/19 21:48:07  dgm
+##      Removed the notion of the startup script reading the config file and
+##      passing arguments to the server process on startup.
+##
+##      Revision 1.1  2002/07/03 14:02:55  dgm
+##      Initial revision
+##
+##
+# Init file for squirrelmail-imap_proxy server daemon
+#
+# chkconfig: 2345 99 10
+# description:  IMAP Proxy Daemon 
+#
+# processname: in.imapproxyd
+# config: /etc/imapproxy.conf
+
+Pgm=`/bin/basename $0`
+PROXY_BIN=/usr/local/sbin/in.imapproxyd
+
+
+start() {
+
+    # make sure the executable exists.
+
+    if [ ! -f $PROXY_BIN ]; then
+	/bin/echo "$Pgm: $PROXY_BIN does not exist.  Not starting IMAP proxy server." 1>&2
+	exit 1
+    fi
+
+    /bin/echo "$Pgm: Starting IMAP proxy server." 1>&2
+
+    $PROXY_BIN
+
+}
+
+
+stop() {
+
+    /bin/echo "$Pgm: Shutting down IMAP proxy server." 1>&2
+
+    pkill -x in.imapproxyd
+
+}
+
+
+case $1 in
+
+    'start')
+	start
+	;;
+
+
+
+    'stop')
+	stop
+	;;
+
+
+    'restart')
+        stop
+        start
+        ;;
+
+
+    *)
+	/bin/echo "usage: $Pgm {start|stop|restart}" 1>&2
+
+	exit 0
+
+	;;
+
+esac
diff --git a/scripts/imapproxy.init b/scripts/imapproxy.init
deleted file mode 100755
index 5fc94bf..0000000
--- a/scripts/imapproxy.init
+++ /dev/null
@@ -1,101 +0,0 @@
-#!/bin/sh
-##
-## Copyright (c) 2010-2011 The SquirrelMail Project Team
-## Copyright (c) 2002-2010 Dave McMurtrie
-##
-## Licensed under the GNU GPL. For full terms see the file COPYING.
-##
-## This file is part of SquirrelMail IMAP Proxy.
-##
-##  Facility:
-##
-##	imapproxy.init
-##
-##  Abstract:
-##
-##	in.imapproxyd startup script
-##
-##  Authors:
-##
-##      Dave McMurtrie <davemcmurtrie@hotmail.com>
-##
-##  Version:
-##
-##      $Id$
-##
-##  Modification History:
-##
-##      $Log$
-##
-##      Revision 1.2  2002/12/19 21:48:07  dgm
-##      Removed the notion of the startup script reading the config file and
-##      passing arguments to the server process on startup.
-##
-##      Revision 1.1  2002/07/03 14:02:55  dgm
-##      Initial revision
-##
-##
-# Init file for squirrelmail-imap_proxy server daemon
-#
-# chkconfig: 2345 99 10
-# description:  IMAP Proxy Daemon 
-#
-# processname: in.imapproxyd
-# config: /etc/imapproxy.conf
-
-Pgm=`/bin/basename $0`
-PROXY_BIN=/usr/local/sbin/in.imapproxyd
-
-
-start() {
-
-    # make sure the executable exists.
-
-    if [ ! -f $PROXY_BIN ]; then
-	/bin/echo "$Pgm: $PROXY_BIN does not exist.  Not starting IMAP proxy server." 1>&2
-	exit 1
-    fi
-
-    /bin/echo "$Pgm: Starting IMAP proxy server." 1>&2
-
-    $PROXY_BIN
-
-}
-
-
-stop() {
-
-    /bin/echo "$Pgm: Shutting down IMAP proxy server." 1>&2
-
-    pkill -x in.imapproxyd
-
-}
-
-
-case $1 in
-
-    'start')
-	start
-	;;
-
-
-
-    'stop')
-	stop
-	;;
-
-
-    'restart')
-        stop
-        start
-        ;;
-
-
-    *)
-	/bin/echo "usage: $Pgm {start|stop|restart}" 1>&2
-
-	exit 0
-
-	;;
-
-esac
-- 
2.7.4

