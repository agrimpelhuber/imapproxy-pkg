From 78a2fa9397cd6f0314468605f0846b98826bd70f Mon Sep 17 00:00:00 2001
From: Paul Lesniewski <paul@squirrelmail.org>
Date: Wed, 14 Sep 2016 02:01:49 +0000
Subject: [PATCH 47/50] Make use of the no_new_privs flag (Linux only) when
 becoming non-root (thanks to Shawn Landden)

git-svn-id: https://svn.code.sf.net/p/squirrelmail/code/trunk/imap_proxy@14570 7612ce4b-ef26-0410-bec9-ea0150e637f0
---
 ChangeLog           |  2 ++
 include/imapproxy.h |  4 ++++
 src/becomenonroot.c | 14 ++++++++++++++
 3 files changed, 20 insertions(+)

diff --git a/ChangeLog b/ChangeLog
index f7b8b80..aedf1c0 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -5,6 +5,8 @@
 	  LibreSSL, other small fixes provided by the BSD team
 	* Fixed anomalous crashes recycling used connections (thanks
 	  to Emmanuel Dreyfus)
+	* Make use of the no_new_privs flag (Linux only) when becoming
+	  non-root (thanks to Shawn Landden)
 
 2014-01-20  Paul Lesniewski <paul@squirrelmail.org>
 	* Added support for up to TLS v1.2 (thanks to Emmanuel Dreyfus)
diff --git a/include/imapproxy.h b/include/imapproxy.h
index 34a01e9..3067daf 100644
--- a/include/imapproxy.h
+++ b/include/imapproxy.h
@@ -153,6 +153,10 @@
 #include <limits.h>
 #endif
 
+#ifndef PR_SET_NO_NEW_PRIVS
+#define PR_SET_NO_NEW_PRIVS 38
+#endif
+
 
 /* 
  * Common definitions 
diff --git a/src/becomenonroot.c b/src/becomenonroot.c
index d583d29..386f176 100644
--- a/src/becomenonroot.c
+++ b/src/becomenonroot.c
@@ -57,6 +57,9 @@
 #if HAVE_UNISTD_H
 #include <unistd.h>
 #endif
+#ifdef __linux__
+#include <sys/prctl.h>
+#endif
 
 #include "imapproxy.h"
 
@@ -186,6 +189,17 @@ extern int BecomeNonRoot( void )
 	return(-1);
     }
     
+#ifdef __linux__
+    if ( prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0) < 0)
+    {
+	syslog( LOG_WARNING, "%s: prctl(PR_SET_NO_NEW_PRIVS, 1) failed: %s",  fn,
+	    strerror(errno));
+	if ( errno == EINVAL )
+	    syslog( LOG_INFO, "%s: Perhaps kernel too old (<3.5)", fn);
+    } else
+	syslog( LOG_INFO, "%s: enabled no_new_privs",  fn);
+#endif
+
     return(0);
 }
 
-- 
2.7.4

